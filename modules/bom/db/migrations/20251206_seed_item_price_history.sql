-- Seed price history from embedded TSV (item_code, price, date_new_price)
-- Parses DD/MM/YYYY HH24:MI:SS or DD/MM/YYYY 00:00:00

WITH raw(tsv) AS (
  VALUES ($$item_code	price	date_new_price
IT-000001	1.60	20/09/2024 00:00:00
IT-000001	1.6	11/04/2025 16:37:00
IT-000002	1.60	20/09/2024 00:00:00
IT-000002	1.6	11/04/2025 16:37:00
IT-000003	1.60	20/09/2024 00:00:00
IT-000003	1.6	11/04/2025 16:37:00
IT-000004	1.60	20/09/2024 00:00:00
IT-000004	1.6	11/04/2025 16:38:00
IT-000005	2.00	20/09/2024 00:00:00
IT-000005	2	11/04/2025 16:38:00
IT-000006	2.00	20/09/2024 00:00:00
IT-000006	2	11/04/2025 16:38:00
IT-000007	2.00	20/09/2024 00:00:00
IT-000007	2	11/04/2025 16:38:00
IT-000008	1.60	20/09/2024 00:00:00
IT-000008	1.6	11/04/2025 16:38:00
IT-000009	0.20	20/09/2024 00:00:00
IT-000009	0.21	11/04/2025 16:30:00
IT-000010	0.15	20/09/2024 00:00:00
IT-000011	12.44	20/09/2024 00:00:00
IT-000011	12.44	11/04/2025 16:28:00
IT-000012	0.28	20/09/2024 00:00:00
IT-000012	0.31	11/04/2025 16:30:00
IT-000013	103.56	20/09/2024 00:00:00
IT-000013	108.74	11/04/2025 16:30:00
IT-000014	37.44	20/09/2024 00:00:00
IT-000014	55.8	11/04/2025 16:28:00
IT-000015	66.65	20/09/2024 00:00:00
IT-000015	75.58	11/04/2025 16:30:00
IT-000019	0.71	20/09/2024 00:00:00
IT-000021	16.22	20/09/2024 00:00:00
IT-000021	16.22	11/04/2025 16:28:00
IT-000023	34.96	20/09/2024 00:00:00
IT-000023	37.96	11/04/2025 16:31:00
IT-000023	0.63	22/04/2025 14:23:00
IT-000026	37.44	20/09/2024 00:00:00
IT-000026	42.2	11/04/2025 16:30:00
IT-000027	56.35	20/09/2024 00:00:00
IT-000027	59.7	11/04/2025 16:30:00
IT-000029	21.38	20/09/2024 00:00:00
IT-000029	21.38	11/04/2025 16:30:00
IT-000030	54.78	20/09/2024 00:00:00
IT-000030	59.25	11/04/2025 16:30:00
IT-000033	1.14	20/09/2024 00:00:00
IT-000034	3.10	20/09/2024 00:00:00
IT-000034	3.1	11/04/2025 16:30:00
IT-000035	1.96	20/09/2024 00:00:00
IT-000041	22.21	20/09/2024 00:00:00
IT-000041	28.01	11/04/2025 16:31:00
IT-000042	27.77	20/09/2024 00:00:00
IT-000042	35.01	11/04/2025 16:31:00
IT-000043	34.43	20/09/2024 00:00:00
IT-000043	43.42	11/04/2025 16:32:00
IT-000044	37.77	20/09/2024 00:00:00
IT-000044	47.62	11/04/2025 16:32:00
IT-000045	53.31	20/09/2024 00:00:00
IT-000045	53.31	11/04/2025 16:32:00
IT-000049	12.98	20/09/2024 00:00:00
IT-000049	12.98	11/04/2025 16:30:00
IT-000050	17.30	20/09/2024 00:00:00
IT-000051	197.85	20/09/2024 00:00:00
IT-000052	93.24	20/09/2024 00:00:00
IT-000053	9.87	20/09/2024 00:00:00
IT-000053	9.87	11/04/2025 16:30:00
IT-000054	9.83	20/09/2024 00:00:00
IT-000055	5.96	20/09/2024 00:00:00
IT-000056	5.96	20/09/2024 00:00:00
IT-000057	37.52	20/09/2024 00:00:00
IT-000058	48.28	20/09/2024 00:00:00
IT-000059	0.10	20/09/2024 00:00:00
IT-000060	0.10	20/09/2024 00:00:00
IT-000061	0.10	20/09/2024 00:00:00
IT-000062	0.10	20/09/2024 00:00:00
IT-000063	0.10	20/09/2024 00:00:00
IT-000065	2.00	20/09/2024 00:00:00
IT-000065	2	11/04/2025 16:38:00
IT-000066	0.10	20/09/2024 00:00:00
IT-000101	220mV Redox	20/09/2024 00:00:00 -- ignored (non-numeric)
IT-000102	240mV Redox	20/09/2024 00:00:00 -- ignored (non-numeric)
IT-000103	1.38	20/09/2024 00:00:00
IT-000104	0.68	20/09/2024 00:00:00
IT-000105	121.95	20/09/2024 00:00:00
IT-000106	119.85	20/09/2024 00:00:00
IT-000107	13.32	20/09/2024 00:00:00
IT-000108	130.80	20/09/2024 00:00:00
IT-000109	63.60	20/09/2024 00:00:00
IT-000110	105.27	20/09/2024 00:00:00
IT-000111	31.28	20/09/2024 00:00:00
IT-000117	245.55	20/09/2024 00:00:00
IT-000118	8.82	20/09/2024 00:00:00
IT-000118	8.82	11/04/2025 16:31:00
IT-000122	5.00	20/09/2024 00:00:00
IT-000122	5	21/09/2024 00:00:00
IT-000122	5	20/09/2024 17:52:00
IT-000123	5	21/09/2024 17:52:00
IT-000124	584	14/01/2025 13:32:00
IT-000125	50.1	20/01/2025 16:46:00
IT-000126	180.15	10/03/2025 15:19:00
IT-000127	316.2	28/03/2025 09:31:00
IT-000128	144.45	28/03/2025 09:33:00
IT-000129	59.25	28/03/2025 09:35:00
IT-000130	120.45	07/05/2025 17:41:00
IT-000131	69	09/05/2025 09:41:00
IT-000132	690	20/05/2025 17:02:00
IT-000133	43.6	23/05/2025 07:42:00
IT-000134	132.97	14/07/2025 11:48:00
IT-000135	111.3	24/07/2025 12:56:00
IT-000136	114.45	12/08/2025 10:01:00
IT-000137	50.3	29/10/2025 09:18:00
IT-000138	135.03	17/11/2025 14:31:00
IT-000139	105	17/11/2025 14:32:00
IT-000140	280.5	17/11/2025 14:33:00
IT-000141	280.5	25/11/2025 10:53:00
IT-000142	280.5	25/11/2025 10:48:00$$)
)
, lines AS (
  SELECT regexp_split_to_table(replace(tsv, E'\r', ''), E'\n') AS line
  FROM raw
)
, parsed AS (
  SELECT
    nullif(btrim((string_to_array(line, E'\t'))[1]), '') AS item_code,
    nullif(btrim((string_to_array(line, E'\t'))[2]), '') AS price_str,
    nullif(btrim((string_to_array(line, E'\t'))[3]), '') AS date_str
  FROM lines
)
, rows AS (
  SELECT * FROM parsed OFFSET 1 -- skip header
)
INSERT INTO mod_bom_item_vendor_prices(org_id, item_id, supplier_id, price, currency, effective_at, source, created_at, updated_at)
SELECT COALESCE(i.org_id, v.org_id) AS org_id,
       i.id AS item_id,
       v.supplier_id,
       CAST(REPLACE(r.price_str, ',', '.') AS NUMERIC) AS price,
       NULL AS currency,
       to_timestamp(r.date_str, 'DD/MM/YYYY HH24:MI:SS') AS effective_at,
       'seed' AS source,
       NOW(), NOW()
  FROM rows r
  JOIN mod_bom_items i ON lower(btrim(i.sku)) = lower(btrim(r.item_code))
  LEFT JOIN LATERAL (
    SELECT iv.org_id, iv.supplier_id
      FROM mod_bom_item_vendors iv
     WHERE iv.item_id = i.id
     ORDER BY iv.preferred DESC, COALESCE(iv.priority, 999) ASC
     LIMIT 1
  ) v ON TRUE
 WHERE r.price_str ~ '^[0-9]+([\.,][0-9]+)?$'
   AND r.date_str ~ '^[0-9]{2}/[0-9]{2}/[0-9]{4}'
ON CONFLICT (item_id, COALESCE(supplier_id, -1), effective_at, price) DO NOTHING;

