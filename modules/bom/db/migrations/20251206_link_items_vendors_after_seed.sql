-- Link items to vendors after items/suppliers are seeded
-- This version is robust to org_id (NULL or non-NULL) and case/whitespace differences.

WITH vendor_map(item_code, vendor_name) AS (
  VALUES
    ('IT-000001','HYDROCAL'),
    ('IT-000002','HYDROCAL'),
    ('IT-000003','HYDROCAL'),
    ('IT-000004','HYDROCAL'),
    ('IT-000005','HYDROCAL'),
    ('IT-000006','HYDROCAL'),
    ('IT-000007','HYDROCAL'),
    ('IT-000008','HYDROCAL'),
    ('IT-000009','ALI EXPRESS'),
    ('IT-000010','Sensorex s.r.o.'),
    ('IT-000011','Sensorex s.r.o.'),
    ('IT-000012','ALI EXPRESS'),
    ('IT-000013','RWC'),
    ('IT-000014','Sensorex s.r.o.'),
    ('IT-000015','RWC'),
    ('IT-000016','3dtiskservice.cz'),
    ('IT-000017','3dtiskservice.cz'),
    ('IT-000018','3dtiskservice.cz'),
    ('IT-000019','prumex.cz'),
    ('IT-000020','3dtiskservice.cz'),
    ('IT-000021','Sensorex s.r.o.'),
    ('IT-000022','3dtiskservice.cz'),
    ('IT-000023','amazon.com'),
    ('IT-000024','3dtiskservice.cz'),
    ('IT-000025','3dtiskservice.cz'),
    ('IT-000026','Sensorex s.r.o.'),
    ('IT-000027','Sensorex s.r.o.'),
    ('IT-000028','3dtiskservice.cz'),
    ('IT-000029','Sensorex s.r.o.'),
    ('IT-000030','Sensorex s.r.o.'),
    ('IT-000031','3dtiskservice.cz'),
    ('IT-000032','3dtiskservice.cz'),
    ('IT-000033','prumex.cz'),
    ('IT-000034','Sensorex s.r.o.'),
    ('IT-000035','prumex.cz'),
    ('IT-000036','3dtiskservice.cz'),
    ('IT-000037','3dtiskservice.cz'),
    ('IT-000038',''),
    ('IT-000039','3dtiskservice.cz'),
    ('IT-000040','obchod-vtp.cz'),
    ('IT-000041','obchod-vtp.cz'),
    ('IT-000042','obchod-vtp.cz'),
    ('IT-000043','obchod-vtp.cz'),
    ('IT-000044','obchod-vtp.cz'),
    ('IT-000045','obchod-vtp.cz'),
    ('IT-000046','3dtiskservice.cz'),
    ('IT-000047','3dtiskservice.cz'),
    ('IT-000048','3dtiskservice.cz'),
    ('IT-000049','Sensorex s.r.o.'),
    ('IT-000050','Sensorex s.r.o.'),
    ('IT-000051','Sensorex s.r.o.'),
    ('IT-000052','Sensorex s.r.o.'),
    ('IT-000053','HAMIZA s.r.o'),
    ('IT-000054','HAMIZA s.r.o'),
    ('IT-000055','HAMIZA s.r.o'),
    ('IT-000056','HAMIZA s.r.o'),
    ('IT-000057','RWC'),
    ('IT-000058','RWC'),
    ('IT-000059','HYDROCAL'),
    ('IT-000060','HYDROCAL'),
    ('IT-000061','HYDROCAL'),
    ('IT-000062','HYDROCAL'),
    ('IT-000063','HYDROCAL'),
    ('IT-000064','HYDROCAL'),
    ('IT-000065','HYDROCAL'),
    ('IT-000066','HYDROCAL'),
    ('IT-000067','3dtiskservice.cz'),
    ('IT-000068','3dtiskservice.cz'),
    ('IT-000069','3dtiskservice.cz'),
    ('IT-000070','3dtiskservice.cz'),
    ('IT-000071','3dtiskservice.cz'),
    ('IT-000072','3dtiskservice.cz'),
    ('IT-000073','3dtiskservice.cz'),
    ('IT-000074','3dtiskservice.cz'),
    ('IT-000075','3dtiskservice.cz'),
    ('IT-000076','3dtiskservice.cz'),
    ('IT-000077','3dtiskservice.cz'),
    ('IT-000078','3dtiskservice.cz'),
    ('IT-000079','3dtiskservice.cz'),
    ('IT-000080','3dtiskservice.cz'),
    ('IT-000081','3dtiskservice.cz'),
    ('IT-000082','3dtiskservice.cz'),
    ('IT-000083','3dtiskservice.cz'),
    ('IT-000084','3dtiskservice.cz'),
    ('IT-000085','3dtiskservice.cz'),
    ('IT-000086','3dtiskservice.cz'),
    ('IT-000087','3dtiskservice.cz'),
    ('IT-000088','3dtiskservice.cz'),
    ('IT-000089','3dtiskservice.cz'),
    ('IT-000090','3dtiskservice.cz'),
    ('IT-000091','3dtiskservice.cz'),
    ('IT-000092','3dtiskservice.cz'),
    ('IT-000093','3dtiskservice.cz'),
    ('IT-000094','3dtiskservice.cz'),
    ('IT-000095','3dtiskservice.cz'),
    ('IT-000096','3dtiskservice.cz'),
    ('IT-000097','3dtiskservice.cz'),
    ('IT-000098',''),
    ('IT-000099','3dtiskservice.cz'),
    ('IT-000100','3dtiskservice.cz'),
    ('IT-000101','3dtiskservice.cz'),
    ('IT-000102','3dtiskservice.cz'),
    ('IT-000103','prumex.cz'),
    ('IT-000104','prumex.cz'),
    ('IT-000105','Sensorex s.r.o.'),
    ('IT-000106','Sensorex s.r.o.'),
    ('IT-000107','Sensorex s.r.o.'),
    ('IT-000108','Sensorex s.r.o.'),
    ('IT-000109','Sensorex s.r.o.'),
    ('IT-000110','Sensorex s.r.o.'),
    ('IT-000111','Sensorex s.r.o.'),
    ('IT-000112','shop.elektrosms.cz'),
    ('IT-000113','shop.elektrosms.cz'),
    ('IT-000114','shop.elektrosms.cz'),
    ('IT-000115','shop.elektrosms.cz'),
    ('IT-000116','FARNEL'),
    ('IT-000117','Sensorex s.r.o.'),
    ('IT-000118','HAMIZA s.r.o'),
    ('IT-000119','shop.elektrosms.cz'),
    ('IT-000120','shop.elektrosms.cz'),
    ('IT-000122','TEST6'),
    ('IT-000122','TEST8'),
    ('IT-000123','nn'),
    ('IT-000123','Sensorex s.r.o.'),
    ('IT-000124','Sensorex s.r.o.'),
    ('IT-000125','Sensorex s.r.o.'),
    ('IT-000126','Sensorex s.r.o.'),
    ('IT-000127','Sensorex s.r.o.'),
    ('IT-000128','Sensorex s.r.o.'),
    ('IT-000129','Sensorex s.r.o.'),
    ('IT-000130','Sensorex s.r.o.'),
    ('IT-000023','ALI EXPRESS'),
    ('IT-000131','Sensorex s.r.o.'),
    ('IT-000132','ITM'),
    ('IT-000133','Sensorex s.r.o.'),
    ('IT-000134','Sensorex s.r.o.'),
    ('IT-000135','Sensorex s.r.o.'),
    ('IT-000136','Sensorex s.r.o.'),
    ('IT-000137','Sensorex s.r.o.'),
    ('IT-000138','Sensorex s.r.o.'),
    ('IT-000139','Sensorex s.r.o.'),
    ('IT-000140','Sensorex s.r.o.'),
    ('IT-000141','Sensorex s.r.o.'),
    ('IT-000142','Sensorex s.r.o.')
)
, vm_clean AS (
  SELECT lower(btrim(item_code)) AS item_code,
         lower(btrim(vendor_name)) AS vendor_name
  FROM vendor_map
  WHERE vendor_name IS NOT NULL AND btrim(vendor_name) <> ''
)
-- Ensure suppliers exist (for any org). Insert into NULL org_id if missing globally.
, ins_suppliers AS (
  INSERT INTO mod_bom_suppliers(org_id, name, created_at, updated_at)
  SELECT NULL, s.vendor_name_orig, NOW(), NOW()
    FROM (
      SELECT DISTINCT vendor_name AS vendor_name_orig FROM vm_clean
    ) s
   WHERE NOT EXISTS (
     SELECT 1 FROM mod_bom_suppliers t WHERE lower(btrim(t.name)) = s.vendor_name_orig
   )
  RETURNING id
)
INSERT INTO mod_bom_item_vendors(org_id, item_id, supplier_id, preferred, created_at, updated_at)
SELECT COALESCE(s.org_id, i.org_id) AS org_id,
       i.id AS item_id,
       s.id AS supplier_id,
       FALSE,
       NOW(), NOW()
  FROM vm_clean vm
  JOIN mod_bom_items i
    ON lower(btrim(i.sku)) = vm.item_code
  JOIN mod_bom_suppliers s
    ON lower(btrim(s.name)) = vm.vendor_name
ON CONFLICT (item_id, supplier_id) DO NOTHING;

